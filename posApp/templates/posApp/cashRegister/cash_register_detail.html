{% extends "posApp/base.html" %} {% block pageContent %}
{% load format_filters %}

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <a href="{% url 'cash_register-page' %}" class="me-2" title="Regresar a la lista">
            <i class="fa-solid fa-arrow-left"></i>
          </a>
          <h4 class="card-title mb-0">Detalle Caja</h4>
        </div>
        <div class="text-end">
          <div>Cajero: <b>{{ cash_register.user.username }}</b></div>
          <div>Fecha Apertura: {{ cash_register.opening_date|date:"d/m/Y H:i:s" }}</div>
          <div>Estado: <b>{% if cash_register.close_date %}Cerrado{% else %}Abierto{% endif %}</b></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resumen de Caja -->
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card p-3">
      <div class="row">
        <!-- Ingresos por tipo de pago -->
        <div class="col-md-4">
          <div class="border rounded p-3 h-100 text-success">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-dark fw-bold">Ingresos por Tipo de Pago 💳</small>
            </div>
            <ul class="ps-3 mb-0 text-dark" style="font-size: 0.875rem;">
              {% for item in ingresos_por_tipo_pago %}
                <li>
                  {{ item.tipo }}: S/ {{ item.monto|punto_decimal }}
                </li>
              {% empty %}
                <li>Sin datos</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      
        <!-- Ingresos por producto -->
        <div class="col-md-4">
          <div class="border rounded p-3 h-100 text-info">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-dark fw-bold">Ingresos por Producto 📦</small>
            </div>
            <ul class="ps-3 mb-0 text-dark" style="font-size: 0.875rem;">
              {% for item in ingresos_por_producto %}
                <li>
                  {{ item.nombre }}: S/ {{ item.total_monto|punto_decimal }} 
                  ({{ item.total_cantidad|floatformat:0 }} uds)
                </li>
              {% empty %}
                <li>Sin datos</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      
        <!-- Consolidado -->
        <div class="col-md-4">
          <div class="border rounded p-3 h-100 bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <small class="text-dark fw-bold">Consolidado 📊</small>
            </div>
            <ul class="ps-0 mb-0 list-unstyled" style="font-size: 0.875rem;">
              <li>
                <strong class="text-success">Ingresos:</strong>
                <span class="float-end">S/ {{ income_total|punto_decimal }}</span>
              </li>
              <li>
                <strong class="text-danger">Gastos:</strong>
                <span class="float-end">S/ {{ expense_total|punto_decimal }}</span>
              </li>
              <hr>
              <li>
                <strong class="text-primary">Total Neto:</strong>
                <span class="float-end">S/ {{ final_total|punto_decimal }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Único contenedor con NavTabs -->
  <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
      <!-- Nav tabs -->
      <ul class="nav nav-tabs" id="cashTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="tab-expenses" data-toggle="tab" href="#pane-expenses" role="tab" aria-controls="pane-expenses" aria-selected="true">
            Gastos
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="tab-sales" data-toggle="tab" href="#pane-sales" role="tab" aria-controls="pane-sales" aria-selected="false">
            Ventas
          </a>
        </li>
      </ul>
      <!-- Tab panes -->
      <div class="tab-content" id="cashTabsContent">
        <!-- PANE 1: Gastos -->
        <div class="tab-pane fade show active p-3" id="pane-expenses" role="tabpanel" aria-labelledby="tab-expenses">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h4 class="card-title">Gastos</h4>
            {% if not cash_register.close_date %}
                <button class="btn btn-primary bg-gradient btn-sm rounded-0" id="create_new" data-id="{{ cash_register.pk }}">
                  <i class="mdi mdi-plus"></i><span> Agregar nuevo</span>
                </button>
            {% endif %}
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Descripción</th>
                  <th>Monto</th>
                  <th>Fecha</th>
                  <th class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for expense in expenses %}
                <tr>
                  <td>{{ expense.description }}</td>
                  <td>{{ expense.amount|punto_decimal }}</td>
                  <td>{{ expense.expense_date|date:"d/m/Y H:i:s" }}</td>
                  <td class="px-2 py-1 text-center">
                    {% if not cash_register.close_date and user.is_superuser %}
                      <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--danger mdc-ripple-upgraded delete-data"
                                type="button"
                                data-id="{{ expense.pk }}"
                                title="Delete">
                          <i class="material-icons mdc-button__icon">deleteoutline</i>
                        </button>
                    {% endif %}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No hay gastos registrados para esta caja.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <!-- PANE 2: Ventas -->
        <div class="tab-pane fade p-3" id="pane-sales" role="tabpanel" aria-labelledby="tab-sales">
          <h4 class="card-title mb-2">Ventas de la Caja</h4>
          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Código de Venta</th>
                  <th>Sub Total</th>
                  <th>Total</th>
                  <th>Fecha de Venta</th>
                  <th>Detalle</th>
                </tr>
              </thead>
              <tbody>
                {% for sale in sales %}
                <tr>
                  <td>{{ sale.code }}</td>
                  <td>S/ {{ sale.sub_total|punto_decimal }}</td>
                  <td>S/ {{ sale.grand_total|punto_decimal }}</td>
                  <td>{{ sale.date_added|date:"d/m/Y H:i:s" }}</td>
                  <td>
                    <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded view-data" type="button" data-id="{{ sale.id }}" title="View Receipt">
                        <i class="material-icons mdc-button__icon">receipt</i>
                    </button>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center">No hay ventas registradas para esta caja.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock pageContent %} {% block ScriptBlock %}
<script>
    $(function() {
        $('#create_new').click(function() {
            uni_modal("Registrar Gasto", "{% url 'cash_register_expenses-modal' %}?id=" + $(this).attr('data-id'))
        })
        $('.view-data').click(function() {
            uni_modal("Boleta emitida", "{% url 'receipt-modal' %}?id=" + $(this).attr('data-id'))
        })
        $('.delete-data').click(function() {
            _conf("¿Esta seguro de borrar este gasto?", "delete_payment", [$(this).attr('data-id')])
        })    
        $('#cashTabs a').on('click', function (e) {
            e.preventDefault();
            $(this).tab('show');
        });
    })

    function delete_payment($id) {
        start_loader();
        $.ajax({
            headers: {
                "X-CSRFToken": '{{csrf_token}}'
            },
            url: "{% url 'delete-cash_register_expenses' %}",
            method: "POST",
            data: {
                id: $id
            },
            dataType: "json",
            error: err => {
                console.log(err);
                alert("Ocurrió un error al intentar eliminar.");
                end_loader();
            },
            success: function(resp) {
                if (typeof resp == 'object' && resp.status == 'success') {
                    location.reload();
                } else if (resp.status == 'failed' && resp.message) {
                    alert(resp.message); 
                } else {
                    alert("Ocurrió un error inesperado.");
                }
                end_loader();
            }
        });
    }
</script>
{% endblock ScriptBlock %}