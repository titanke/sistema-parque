{% extends "posApp/base.html" %} {% load humanize %} {% block pageContent %}



<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--success">
        <div class="card-inner">
            <h5 class="card-title">Categorias</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ categories|intcomma }}</h5>
            <p class="tx-12 text-muted">Recuento de categorias</p>
            <div class="card-icon-wrapper">
                <i class="material-icons">list</i>
            </div>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--primary">
        <div class="card-inner">
            <h5 class="card-title">Productos</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ products|intcomma }}</h5>
            <p class="tx-12 text-muted">Recuento de productos</p>
            <div class="card-icon-wrapper">
                <i class="material-icons">label</i>
            </div>
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--info">
        <div class="card-inner">
            <h5 class="card-title">Transacciones de hoy</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">{{ transaction|intcomma }}</h5>
            <p class="tx-12 text-muted">Recuento de transacciones</p>
            <div class="card-icon-wrapper">
                <i class="material-icons">description</i>
            </div>
        </div>
    </div>
</div>
{% if request.user.is_superuser %}

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-3-desktop mdc-layout-grid__cell--span-3-tablet">
    <div class="mdc-card info-card info-card--warning">
        <div class="card-inner">
            <h5 class="card-title">Ventas de hoy</h5>
            <h5 class="font-weight-light pb-2 mb-1 border-bottom">S/ {{ total_sales|intcomma }}</h5>
            <p class="tx-12 text-muted">Total</p>
            <div class="card-icon-wrapper">
                <i class="mdi mdi-cash-multiple"></i>
            </div>
        </div>
    </div>
</div>

      <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-4-desktop">

      </div>
    </div>
  
    <!-- Gráficos en una sola fila -->
    <div class="mdc-layout-grid__inner">
      <!-- Gráfico de barras -->
      <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-4-desktop">
        <div class="card w-100 p-2">
          <h6 class="text-center">Ingresos Netos Mensuales</h6>
          <label for="yearSelector">Año</label>
          <select id="yearSelector" class="form-control">
            {% for y in year_range  %}
              <option value="{{ y }}" {% if y == now.year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
          <canvas id="ventasMensualesChart" height="200"></canvas>
        </div>
      </div>
  
      <!-- Gráfico de líneas -->
      <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-4-desktop">
        <div class="card w-100 p-2">
          <h6 class="text-center">Ingresos Netos Diarios</h6>
          <label for="monthSelector">Mes</label>
          <select id="monthSelector" class="form-control">
            {% for m in months %}
              <option value="{{ forloop.counter }}" {% if forloop.counter == now.month %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
          <canvas id="ventasDiariasChart" style="width: 100%; height: 100%; max-height: 500px;"></canvas>
        </div>
      </div>
  
      <!-- Gráfico dona -->
      <div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-4-desktop">
        <div class="card w-100 p-2 position-relative">
          <h6 id="productosFechaSeleccionada" class="text-center" style="font-size: 0.9em;"></h6>
          <canvas id="productosDonaChart" style="width: 100%; height: 100%; max-height: 500px;"></canvas>
          <div id="totalProductos" class="position-absolute top-50 start-50 translate-middle fw-bold fs-5">
            0
          </div>
        </div>
      </div>
   
  

  
{% endif %}

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">

</div>





<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const yearSelect = document.getElementById('yearSelector');
    const monthSelect = document.getElementById('monthSelector');
  
    const ventasMensualesChart = new Chart(document.getElementById('ventasMensualesChart'), {
      type: 'bar',
      data: {
          labels: [], // Esto se rellena luego con data.labels
          datasets: [
              {
                  label: 'Ingresos',
                  data: [],
                  backgroundColor: '#245ee3'
              },
              {
                  label: 'Gastos',
                  data: [],
                  backgroundColor: '#e74c3c'
              },
              {
                  label: 'Saldo',
                  data: [],
                  backgroundColor: '#2ecc71'
              }
          ]
      },
      options: {
          responsive: true,
          aspectRatio: 1.2,
          scales: {
              x: {
                  stacked: false, // si lo quieres agrupado
              },
              y: {
                  beginAtZero: true,
                  ticks: {
                      callback: function(value) {
                          return 'S/. ' + value.toLocaleString('es-PE');
                      }
                  }
              }
          },
          plugins: {
              legend: {
                  position: 'top',
              }
          }
      }
  });
  

  const ventasDiariasChart = new Chart(document.getElementById('ventasDiariasChart'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            {
                label: 'Ventas',
                data: [],
                borderColor: '#4CAF50',
                backgroundColor: 'transparent',
                tension: 0.3
            },
            {
                label: 'Gastos',
                data: [],
                borderColor: '#E74C3C',
                backgroundColor: 'transparent',
                tension: 0.3
            },
            {
                label: 'Saldo Neto',
                data: [],
                borderColor: '#3498DB',
                backgroundColor: 'transparent',
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        aspectRatio: 1.2,
        plugins: {
            title: {
                display: true,
                text: 'Ventas, Gastos y Saldos por Día'
            },
            legend: {
                position: 'top'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function (value) {
                        return 'S/. ' + value.toLocaleString('es-PE');
                    }
                }
            }
        }
    }
});

  
    const productosDonaChart = new Chart(document.getElementById('productosDonaChart'), {
      type: 'doughnut',
      data: { labels: [], datasets: [{ data: [], backgroundColor: ['#ff7675', '#74b9ff', '#ffeaa7', '#55efc4'] }] },
      options: {
        responsive: true,
        cutout: '70%',
        aspectRatio: 1.2 
      }
    });
  
    function actualizarGraficos() {
      const year = yearSelect.value;
      const month = monthSelect.value;
      const fechaSpan = document.getElementById('productosFechaSeleccionada');

      fechaSpan.textContent = `Productos por Tipo: ${year}/${month}`;
      // Gráfico de ventas mensuales
      fetch(`dashboard/monthly-sales?year=${year}`)
      .then(res => res.json())
      .then(data => {
          ventasMensualesChart.data.labels = data.labels;
  
          // Asegúrate de limpiar y setear correctamente los datos
          ventasMensualesChart.data.datasets[0].data = data.sales;
          ventasMensualesChart.data.datasets[1].data = data.expenses;
          ventasMensualesChart.data.datasets[2].data = data.saldo;
          console.log(data);

          ventasMensualesChart.update();
      });
  
      // Gráfico de ganancias diarias
      fetch(`dashboard/daily-gains?year=${year}&month=${month}`)
        .then(res => res.json())
        .then(data => {
          ventasDiariasChart.data.labels = data.labels;
          ventasDiariasChart.data.datasets[0].data = data.sales;
          ventasDiariasChart.data.datasets[1].data = data.expenses;
          ventasDiariasChart.data.datasets[2].data = data.saldo;
          ventasDiariasChart.update();
        });
  
      // Gráfico de productos por tipo
      fetch(`dashboard/product-pie?year=${year}&month=${month}`)
        .then(res => res.json())
        .then(data => {
          productosDonaChart.data.labels = data.labels;
          productosDonaChart.data.datasets[0].data = data.data;
          productosDonaChart.update();
          const total = data.data.reduce((a, b) => a + b, 0);
          document.getElementById('totalProductos').textContent = `S/ ${total.toLocaleString('es-PE', { minimumFractionDigits: 2 })}`;
        });
    }
  
    // Eventos
    yearSelect.addEventListener('change', actualizarGraficos);
    monthSelect.addEventListener('change', actualizarGraficos);
  
    // Cargar al inicio
    document.addEventListener('DOMContentLoaded', actualizarGraficos);
  </script>
  

{% endblock pageContent %}