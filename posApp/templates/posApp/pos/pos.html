{% extends "posApp/base.html" %} {% block pageContent %}

<style>

  .mdc-card {
    height: auto !important;
    min-height: 100%;
    overflow: visible;
  }
  #pos-form {
    height: auto;
  }
  
</style>


<audio id="beep" src="https://bigsoundbank.com/UPLOAD/wav/1417.wav" preload="auto"></audio>


<!-- Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrModalLabel">Escanear producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-column align-items-center">
              <video id="preview" style="width: 100%;"></video>
            <!-- Aquí es donde se mostrará el texto del código QR -->
              <p id="qrText"></p>
          </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="checkoutModalLabel">Confirmar Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p><strong>Total a pagar:</strong> <span id="modal_grand_total">0.00</span></p>
          <p><strong>Entregado:</strong> <span id="modal_tendered_amount">0.00</span></p>
          <p><strong>Cambio:</strong> <span id="modal_amount_change">0.00</span></p>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="print_ticket" checked>
            <label class="form-check-label" for="print_ticket">Imprimir ticket</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirm_submit">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

<div class="modal fade" id="modalCajaCerrada" tabindex="-1" aria-labelledby="modalCajaCerradaLabel" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalCajaCerradaLabel">Caja no abierta</h5>
      </div>
      <div class="modal-body text-center">
        Debes abrir una caja para acceder al punto de venta.
      </div>
      <div class="modal-footer justify-content-center">
        <a href="{% url 'cash_register-page' %}" class="btn btn-primary">Ir a abrir caja</a>
      </div>
    </div>
  </div>
</div>



<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Ventas</h4>
            <div class="d-flex align-items-center">
                <label for="cash_register_select" style="white-space: nowrap;">Fecha Caja:</label>
                <select id="cash_register_select" class="form-select form-select-sm" name="cash_register_id"> 
                    {% for cash_register in cash_registers %}
                        <option value="{{ cash_register.id }}">
                            {{ cash_register.opening_date|date:"d/m/Y H:i:s" }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>



<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
  <div class="mdc-card" >
    <form action="" id="pos-form" method="POST">
        {% csrf_token %}
        <input type="hidden" name="cash_register_id" id="cash_register_id_input" value="{{ cash_register.pk }}">
        <fieldset>
            <div class="row g-3" id="POS-field">
                <div class="col-12 col-md-8 items-column p-0">
                  <div class="row g-3 mb-3 align-items-end">
                      <div class="col-6 col-sm-6">
                          <label for="product-id" class="form-label">Seleccionar producto</label>
                          <select id="product-id" class="form-select form-select-sm">
                          <option value="--" disabled selected></option>
                          {% for product in products %}
                              <option value="{{ product.pk }}" data-stock="{{ product.stock }}">
                                {{ product.name }}{% if product.category_id.name != 'TICKET' and product.category_id.name != 'ATRACCIÓN' %} (stk: {{ product.stock }}){% endif %}
                              </option>
                          {% endfor %}
                          </select>
                      </div>
                      <div class="col-3 col-sm-3">
                          <label for="product-qty" class="form-label">Cantidad</label>
                          <input type="number"
                                  class="form-control form-control-sm text-center"
                                  step="any"
                                  id="product-qty"
                                  value="1">
                      </div>
                      <div class="col-3 pr-3">
                          <button class="btn btn-success btn-sm rounded-0 w-100"
                                  type="button"
                                  id="add_item">
                          <i class="mdi mdi-plus"></i>
                          </button>
                      </div>
                  </div>
                  <div class="bg-gradient bg-light border p-2 items-container">

                    <div class="table-responsive">
                      <table class="table table-bordered mb-0">
                        <colgroup>
                          <col width="5%">
                          <col width="15%">
                          <col width="40%">
                          <col width="20%">
                          <col width="20%">
                        </colgroup>
                        <thead>
                          <tr class="bg-dark bg-gradient bg-opacity-50">
                            <th class="py-1 px-2 text-center text-white"></th>
                            <th class="py-1 px-2 text-center text-white">Cant.</th>
                            <th class="py-1 px-2 text-center text-white">Producto</th>
                            <th class="py-1 px-2 text-center text-white">Precio</th>
                            <th class="py-1 px-2 text-center text-white">Total</th>
                          </tr>                          
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
            <div class="col-12 col-md-4 summary-column p-0">
              <div class="summary-panel bg-gradient bg-dark bg-opacity-50 border h-100 p-3 text-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5>Resumen de Venta</h5>
                        <div class="px-3 py-2 rounded text-end">
                            <input type="hidden" name="sub_total" value="0">
                            <input type="hidden" class="form-control form-control-sm rounded-0 text-end" step="any" min="0" max="100" name="descuento" value="0">
                            <input type="hidden" class="form-control form-control-sm rounded-0 text-end" step="any" min="0" max="100" name="tax" value="0">
    
                            <input type="hidden" name="tendered_amount" value="0">
                            <input type="hidden" name="payment_type_id" >
                            <input type="hidden" name="amount_change" value="0">
                            <input type="hidden" name="grand_total" value="0">
                            <input type="hidden" name="tax_amount" value="0">
                            <span class="h6 ">Total: S/ </span>
                            <span class="h4 fw-bold" id="grand_total">0.00</span>
                        </div>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-6">
                      <button class="btn btn-primary btn-sm rounded-0 w-100" id="add-payment-method">
                        <i class="mdi mdi-plus"></i> Pago
                      </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-success btn-sm rounded-0 w-100"
                                type="button"
                                id="check_out">
                          <i class="mdi mdi-check"></i> Finalizar
                        </button>
                      </div>
                  </div>

                  <div id="payment-methods-container">
                    <label for="payment_change" class="control-label">Pagos Registrados</label>
                  
                    <div class="payment-method-entry row g-2 mb-1">
                      <div class="col-6">
                        <select class="form-select form-select-sm payment-type" name="payment_type[]" required>
                          <option value="">-- Tipo de pago --</option>
                          {% for pay in payment %}
                            <option value="{{ pay.id }}">{{ pay.name }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-4">
                        <input type="number" step="any" class="form-control form-control-sm tendered-amount" name="amount[]" placeholder="Monto" required>
                      </div>
                      <div class="col-2">
                        <button type="button" class="btn btn-danger btn-sm remove-payment-method">&times;</button>
                      </div>
                    </div>
                  </div>
                                             
                  <div class="form-group mb-3">
                    <label for="payment_change" class="control-label">Vuelto</label>
                    <input type="text" id="payment_change" class="form-control form-control-sm text-end" value="{{ 0|floatformat:2 }}" required disabled>
                  </div>

              </div>
            </div>
          </div>
        </fieldset>
    </form>
  </div>
</div>



<noscript id="item-clone">
    <tr>
        <td class="px-2 py-1 text-center">
            <button class="btn btn-sm btn-outline-danger rounded-0 rem-item" type="button"><i class="mdi mdi-close"></i></button>
        </td>
        <td class="px-2 py-1">
            <input type="hidden" name="product_id[]">
            <input type="hidden" name="price[]">
            <input type="hidden" name="feature_id[]"> <!-- Asegúrate de incluir este campo -->

            <input type="number" name="qty[]" min="1" class="form-control form-control-sm rounded-0 text-center">
        </td>
        <td class="px-2 py-1 product_name text-start"></td>
        <td class="px-2 py-1 product_price text-end"></td>
        <td class="px-2 py-1 product_total text-end"></td>
    </tr>
</noscript> {% endblock pageContent %} {% block ScriptBlock %}

{% if mostrar_modal %}
<script>
  $(document).ready(function () {
    $('#modalCajaCerrada').modal('show');
  });
</script>
{% endif %}


<script>
    var product_json = '{{ product_json }}'
    if (product_json == "" || product_json == "{}") {
        product_json = {}
    } else {
        product_json = product_json.replaceAll('&quot;', '"')
        product_json = $.parseJSON(product_json)
    }

    var prod_arr = {}; // Almacenará los productos
    var feature_arr = {}; // Almacenará las características de los productos
    
    if (Object.keys(product_json).length > 0) {
        Object.keys(product_json).map(k => {
            var product = product_json[k];
            prod_arr[product.id] = product; // Guardar el producto
            // Procesar características del producto
            if (product.features && product.features.length > 0) {
                product.features.map(feature => {
                    feature_arr[feature.id] = feature; // Guardar cada característica por su ID
                });
            }
        });
    }
    



    $("#scanQR").click(function(){
        $("#qrModal").modal('show');
      });


      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      let beep = document.getElementById('beep');


      scanner.addListener('scan', function (content) {
        const partes = content.split('-');
      
        const idProducto = partes[0];
      
        console.log(idProducto);
        document.getElementById('qrText').innerText = idProducto;
      
        scanner.stop();
      
        beep.play();
      
        $('#product-id').val(idProducto).trigger('change'); // Selecciona y actualiza el select2 con el producto correspondiente
      
        $('#product-qty').val(1);
      
        $("#qrModal").modal('hide');
      });

      $(document).ready(function(){
        $("#scanQR").click(function(){
          Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
              scanner.start(cameras[0]);
            } else {
              console.error('No cameras found.');
            }
          }).catch(function (e) {
            console.error(e);
          });
          $("#qrModal").modal('show');
        });
        $('#qrModal').on('hidden.bs.modal', function (e) {
          document.getElementById('qrText').innerText = "";
          scanner.stop();
          
        })
      });

     //   

    
     $(document).ready(function () {
        let productData = JSON.parse('{{ product_json|escapejs }}');
        const quantityInput = $('#product-qty');
        const featureSelect = $('#feature-id');
        const featureContainer = $('#feature-select-container');
        const productSelect = $('#product-id');
        const cashRegisterSelect = $('#cash_register_select'); 
        const cashRegisterIdInput = $('#cash_register_id_input'); 


        cashRegisterSelect.change(function() {
            cashRegisterIdInput.val($(this).val()); // Set the value of the hidden input
        });

        cashRegisterIdInput.val(cashRegisterSelect.val());

        // Evento al cambiar el producto seleccionado
        productSelect.change(function () {
            let productId = $(this).val();
            let selectedProduct = productData.find(product => product.id == productId);
    
            // Limpiar características y ocultar el contenedor
            featureSelect.empty().append('<option value="" disabled selected></option>');
            featureContainer.addClass('d-none');
    
            if (selectedProduct) {
                // Manejar características si existen
                if (selectedProduct.features.length > 0) {
                    selectedProduct.features.forEach(feature => {
                        featureSelect.append(
                            `<option value="${feature.id}" data-stock="${feature.stock}">
                                ${feature.color} - ${feature.size} (STK: ${feature.stock})
                            </option>`
                        );
                    });
                    featureContainer.removeClass('d-none');
                }
    
                // Establecer el stock máximo para el producto general
                quantityInput.attr('max', selectedProduct.stock || 0);
                quantityInput.val(1); // Reiniciar cantidad
            }
        });
    
        // Evento al cambiar la característica seleccionada
        featureSelect.change(function () {
            let selectedFeature = $(this).find('option:selected');
            let featureStock = parseInt(selectedFeature.data('stock')) || 0;
    
            // Actualizar el stock máximo basado en la característica seleccionada
            quantityInput.attr('max', featureStock);
            quantityInput.val(1); // Reiniciar cantidad
        });
    
        // Validar cantidad ingresada
        quantityInput.on('input', function () {
            let maxStock = parseInt($(this).attr('max')) || 0;
            let currentQty = parseInt($(this).val()) || 0;
    
            if (currentQty > maxStock) {
                $(this).val(maxStock);
                alert('No puedes agregar más cantidad que el stock disponible.');
            }
        });
    });
    
    function calcularVuelto() {
      const total = parseFloat($('#grand_total').text()) || 0;
      let totalPagado = 0;
  
      $('.tendered-amount').each(function () {
        const amount = parseFloat($(this).val()) || 0;
        totalPagado += amount;
      });
  
      const change = totalPagado - total;
  
      // Mostrar en campos ocultos si es necesario
      $('[name="tendered_amount"]').val(totalPagado.toFixed(2));
      $('[name="amount_change"]').val(change.toFixed(2));
      $('#payment_change').val(change.toFixed(2)); // este es visible en el formulario
    }
  

    function calc() {
        var sub_total = 0;
        var grand_total = 0;
      
        $('#POS-field table tbody tr').each(function() {
          price = $(this).find('[name="price[]"]').val();
          qty = $(this).find('[name="qty[]"]').val();
          qty = qty > 0 ? qty : 0;
          total = parseFloat(price) * parseFloat(qty);
          $(this).find('.product_total').text("S/ "+ parseFloat(total));
          sub_total += parseFloat(total);
        });
      
        // Get discount value (assuming it's from an input field)
        descuento = $('[name="descuento"]').val(); // Get and handle potential empty value
      
        // Calculate discount amount as a percentage of subtotal
      
        tax = $('[name="tax"]').val();
        tax = tax/100 ;
        

        var tax_amount = (parseFloat(sub_total)-descuento) * parseFloat(tax);

      

        $('#sub_total').text(parseFloat(sub_total));
        $('[name="sub_total"]').val(parseFloat(sub_total));

        $('#descuento').text(parseFloat(descuento)); // Add display for discount amount (optional)
        $('[name="descuento"]').val(parseFloat(descuento)); // Add input for discount amount (optional)
      
        $('#tax_amount').text(parseFloat(tax_amount));
        $('[name="tax_amount"]').val(parseFloat(tax_amount));
        //grand_total = sub_total - descuento;
        // Update grand total including tax and minus discount

        grand_total = sub_total + tax_amount - descuento;
        $('#grand_total').text(parseFloat(grand_total));
        $('[name="grand_total"]').val(parseFloat(grand_total));
        
      }

    function togglePaymentFields() {
      const hasProducts = $('#POS-field table tbody tr').length > 0;
    
      $('.payment-type').prop('disabled', !hasProducts);
      $('.tendered-amount').prop('disabled', !hasProducts);
      $('#add-payment-method').prop('disabled', !hasProducts); 
    }
    
    $(function() {
        $('#product-id').select2({
            placeholder: "Selecciona los productos",
            width: '100%'
        })

        $('#add_item').click(function() {
            var id = $('#product-id').val()
            var qty = $('#product-qty').val()
            var feature_id = $('#feature-id').val(); // Obtener el ID de la característica seleccionada

            let productData = JSON.parse('{{ product_json|escapejs }}');
            const productId = id;
            const featureId = feature_id;
            const selectedProduct = productData.find(product => product.id == productId);
                
            // Validar que se seleccione una característica si el producto tiene características
            if (selectedProduct && selectedProduct.features.length > 0 && !featureId) {
                alert("Debe seleccionar una característica del producto antes de agregarlo");
                return false;
            }
    
    
            if (id == '' || qty == '' || id == null || qty == null) {
                alert("El campo Producto y Cantidad es obligatorio")
                return false
            }

             
            if (qty == 0) {
              alert("Cantidad no permitida")
              return false
            }

            if (feature_id == '') {
                alert("Debe seleccionar una característica del producto antes de agregarlo");
                return false;
            }
            console.log(feature_id)

            // Si el producto tiene características, se puede agregar varias veces con diferentes combinaciones
            if (!!prod_arr[id]) {
                // Si el producto tiene características, verificar si se ha agregado con la misma combinación de características
                if (feature_id) {
                    if ($('#POS-field table tbody input[name="feature_id[]"][value="' + feature_id + '"]').length > 0) {
                        alert('El producto con las caracteristicas seleccionadas ya está en la lista');
                        return false;
                    }
                } else {
                    // Si el producto no tiene características, verificar si el producto ya está en la lista
                    if ($('#POS-field table tbody input[name="product_id[]"][value="' + id + '"]').length > 0 &&
                        $('#POS-field table tbody input[name="feature_id[]"][value=""]').length > 0) {
                        alert('El producto ya está en la lista');
                        return false;
                    }
                }


                data = prod_arr[id]
                feature = feature_arr[feature_id] || {}; // Datos de la característica (asegúrate de tener feature_arr con información)
                var tr = $($('noscript#item-clone').html()).clone()
                var maxQty = feature_id && feature.stock ? feature.stock : data.stock;

                tr.find('[name="qty[]"]').val(qty)
                tr.find('[name="product_id[]"]').val(id)
                tr.find('[name="price[]"]').val(data.price)
                tr.find('[name="feature_id[]"]').val(feature_id); // Añadir feature_id a la fila

                var productName = data.name;
                if (feature_id && feature.size) productName += " - Tamaño: " + feature.size;
                if (feature_id && feature.color) productName += " - Color: " + feature.color;
        
                tr.find('.product_name').text(productName)
                tr.find('.product_price').text("S/ "+ parseFloat(data.price))
                tr.find('.product_total').text("S/ "+ parseFloat(data.price * qty))
                $('#POS-field table tbody').append(tr)
                $('#product-id').val('').trigger('change')
                $('#product-qty').val(1)
                calc()
                tr.find('[name="qty[]"]').on('input keypress keyup keydown', function() {
                    var currentQty = $(this).val();
                    if (currentQty > maxQty) {
                        $(this).val(maxQty); // Limitar la cantidad a la disponible
                        alert(`No puedes agregar más de ${maxQty} unidades del producto.`);
                    }
                    calcularVuelto()
                    calc()
                })
                tr.find('.rem-item').click(function() {
                    if (confirm("¿Está seguro de eliminar " + data.name + " de la lista de productos?") == true) {
                        tr.remove()
                        togglePaymentFields();
                        calc()
                    }
                })
            } else {
                alert("Producto no definido");
            }
            togglePaymentFields();

        })
        $('[name="tax"], [name="descuento"]').on('input keypress keydown keyup', function() {
        calc();
        })

        $('#check_out').on('click', function () {

            const payments = [];
            let totalPagado = 0;

            
            $('.payment-method-entry').each(function () {
              const paymentType = $(this).find('.payment-type').val();
              const amount = parseFloat($(this).find('.tendered-amount').val()) || 0;

              if (!paymentType || amount <= 0) return;

              payments.push({ payment_type: paymentType, amount: amount });
              totalPagado += amount;
            });



            const grandTotal = parseFloat($('#grand_total').text()) || 0;

            if (grandTotal == 0) {
              alert("No se selecciono una cantidad de productos valida");
              return;
            }

  
            if (totalPagado < grandTotal) {
              alert("El monto total ofrecido es menor al total de la venta.");
              return;
            }

            if ($('#POS-field table tbody tr').length <= 0) {
                alert("Agregue al menos 1 producto primero")
                return false;
            }


            const paymentTypes = [];

            $('.payment-type').each(function () {
              const val = $(this).val();
              if (val) {
                paymentTypes.push(val);
              }
            });
          
            const duplicates = paymentTypes.filter((item, index) => paymentTypes.indexOf(item) !== index);
          
            if (duplicates.length > 0) {
              alert('No puedes usar el mismo método de pago más de una vez.');
              return false;
            }

            const change = totalPagado - grandTotal;

      
            // Mostrar valores en el modal
            $('#modal_grand_total').text(grandTotal.toFixed(2));
            $('#modal_tendered_amount').text(totalPagado.toFixed(2));
            $('#modal_amount_change').text(change.toFixed(2));
      
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            modal.show();
          });
      
          $('#confirm_submit').on('click', function () {
            const printTicket = $('#print_ticket').is(':checked');
          
            if (printTicket) {
              $('<input>').attr({
                type: 'hidden',
                name: 'print_ticket',
                value: '1'
              }).appendTo('#pos-form');
            }
          
            // Construir y agregar métodos de pago
            const payments = [];
            $('.payment-method-entry').each(function () {
              const paymentType = $(this).find('.payment-type').val();
              const amount = parseFloat($(this).find('.tendered-amount').val()) || 0;
          
              if (!paymentType || amount <= 0) return;
          
              payments.push({ payment_type: paymentType, amount: amount });
            });
          
            $('<input>').attr({
              type: 'hidden',
              name: 'payment_methods',
              value: JSON.stringify(payments)
            }).appendTo('#pos-form');
          
            // Enviar formulario
            $('#pos-form').submit();
          });
          

        //Metodos Pago
        $('#add-payment-method').on('click', function () {
          const existingTypes = [];
        
          // Recolectar los métodos de pago ya seleccionados
          $('.payment-type').each(function () {
            const val = $(this).val();
            if (val) {
              existingTypes.push(val);
            }
          });
        
          // Verificar si ya están todos los métodos usados
          const allTypes = [{% for pay in payment %}"{{ pay.id }}",{% endfor %}];
          const availableTypes = allTypes.filter(id => !existingTypes.includes(id));
        
          if (availableTypes.length === 0) {
            alert('Ya se han agregado todos los tipos de pago disponibles.');
            return;
          }
        
          // Evitar que se agregue más de la cantidad permitida
          if ($('.payment-method-entry').length >= allTypes.length) {
            alert('Ya se agregó la cantidad maxima de métodos de pago');
            return;
          }
        
          // Crear el select con solo los métodos de pago disponibles
          let options = `<option value="">-- Tipo de pago --</option>`;
          {% for pay in payment %}
            if (!existingTypes.includes("{{ pay.id }}")) {
              options += `<option value="{{ pay.id }}">{{ pay.name }}</option>`;
            }
          {% endfor %}
        
          const template = `
            <div class="payment-method-entry row g-2 mb-1">
              <div class="col-6">
                <select class="form-select form-select-sm payment-type" name="payment_type[]" required>
                  ${options}
                </select>
              </div>
              <div class="col-4">
                <input type="number" step="any" class="form-control form-control-sm tendered-amount" name="amount[]" placeholder="Monto" required>
              </div>
              <div class="col-2">
                <button type="button" class="btn btn-danger btn-sm remove-payment-method">&times;</button>
              </div>
            </div>
          `;
        
          $('#payment-methods-container').append(template);
        });
        


        // Calcular Vuelto
        $(document).ready(function () {
          togglePaymentFields();
          $(document).on('input', '.tendered-amount', calcularVuelto);
          calcularVuelto();
          togglePaymentFields();
        });

        $(document).on('click', '.remove-payment-method', function () {
          $(this).closest('.payment-method-entry').remove();
          calcularVuelto();  
          togglePaymentFields();
        });

        

        $('#pos-form').submit(function(e) {
            e.preventDefault();
            if (!$('[name="payment_type[]"]').length) {
              alert("Faltan métodos de pago");
              return false;
            }
      
            var _this = $(this)
            $('.err-msg').remove();
            var el = $('<div>')
            el.addClass("alert alert-danger err-msg")
            el.hide()
            if (_this[0].checkValidity() == false) {
                _this[0].reportValidity();
                return false;
            }
            start_loader();
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'save-pos' %}",
                data: new FormData($(this)[0]),
                cache: false,
                contentType: false,
                processData: false,
                method: 'POST',
                type: 'POST',
                dataType: 'json',
                error: err => {
                    console.log(err)
                    end_loader();
                },
                success: function(resp) {

                    const printTicketInput = $('#pos-form').find('input[name="print_ticket"]').val();
                    const printTicket = printTicketInput === '1';
                    if (typeof resp == 'object' && resp.status == 'success') {
                        el.removeClass("alert alert-danger err-msg")
                            // location.reload()


                          uni_modal("Recibo", "{% url 'receipt-modal' %}?id=" + resp.sale_id + (printTicket ? "&print_ticket=1" : ""));
                        $('#uni_modal').on('hide.bs.modal', function() {
                            location.reload()
                        })
                    } else if (resp.status == 'failed' && !!resp.msg) {
                        el.text(resp.msg)
                    } else {
                        el.text("Ocurrio un error", 'error');
                        end_loader();
                        console.err(resp)
                    }
                    _this.prepend(el)
                    el.show('slow')
                    $("html, body, .modal").scrollTop(0);
                    end_loader()
                }
            })
        })
    })
</script>
{% endblock ScriptBlock %}