{% extends "posApp/base.html" %} {% block pageContent %}


<audio id="beep" src="https://bigsoundbank.com/UPLOAD/wav/1417.wav" preload="auto"></audio>


<!-- Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrModalLabel">Escanear producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-column align-items-center">
              <video id="preview" style="width: 100%;"></video>
            <!-- Aquí es donde se mostrará el texto del código QR -->
              <p id="qrText"></p>
          </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="checkoutModalLabel">Confirmar Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p><strong>Total a pagar:</strong> <span id="modal_grand_total">0.00</span></p>
          <p><strong>Entregado:</strong> <span id="modal_tendered_amount">0.00</span></p>
          <p><strong>Cambio:</strong> <span id="modal_amount_change">0.00</span></p>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="print_ticket" checked>
            <label class="form-check-label" for="print_ticket">Imprimir ticket</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="confirm_submit">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

<div class="modal fade" id="modalCajaCerrada" tabindex="-1" aria-labelledby="modalCajaCerradaLabel" aria-hidden="true"
  data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="modalCajaCerradaLabel">Caja no abierta</h5>
      </div>
      <div class="modal-body text-center">
        Debes abrir una caja para acceder al punto de venta.
      </div>
      <div class="modal-footer justify-content-center">
        <a href="{% url 'cash_register-page' %}" class="btn btn-primary">Ir a abrir caja</a>
      </div>
    </div>
  </div>
</div>



<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Ventas</h4>
            <div class="d-flex align-items-center">
                <label for="cash_register_select" class="me-2">Caja Actual:</label>
                <select id="cash_register_select" class="form-select form-select-sm" name="cash_register_id"> 
                    {% for cash_register in cash_registers %}
                        <option value="{{ cash_register.id }}">
                            {{ cash_register.opening_date|date:"d/m/Y H:i:s" }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>



<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
      <form action="" id="pos-form" method="POST">
        {% csrf_token %}
        <input type="hidden" name="cash_register_id" id="cash_register_id_input" value="{{ cash_register.pk }}">
        <fieldset>
            <div class="row g-3" id="POS-field">
                <div class="col-12 col-md-8 items-column p-0">
                    <div class="row g-3 mb-3 align-items-end">
                        <div class="col-6 col-sm-6">
                            <label for="product-id" class="form-label">Seleccionar producto</label>
                            <select id="product-id" class="form-select form-select-sm">
                            <option value="--" disabled selected></option>
                            {% for product in products %}
                                <option value="{{ product.pk }}" data-stock="{{ product.stock }}">
                                COD: {{ product.code }} – {{ product.name }} (stk: {{ product.stock }})
                                </option>
                            {% endfor %}
                            </select>
                        </div>
                        <div class="col-3 col-sm-3">
                            <label for="product-qty" class="form-label">Cantidad</label>
                            <input type="number"
                                    class="form-control form-control-sm text-center"
                                    step="any"
                                    id="product-qty"
                                    value="1">
                        </div>
                        <div class="col-3 pr-3">
                            <button class="btn btn-success btn-sm rounded-0 w-100"
                                    type="button"
                                    id="add_item">
                            <i class="mdi mdi-plus"></i>
                            </button>
                        </div>
                </div>
              <div class="bg-gradient bg-light border h-80 p-2 items-container">
                <table class="table table-bordered mb-0">
                  <colgroup>
                    <col width="5%">
                    <col width="15%">
                    <col width="40%">
                    <col width="20%">
                    <col width="20%">
                  </colgroup>
                  <thead>
                    <tr class="bg-dark bg-gradient bg-opacity-50 text-light">
                      <th class="py-1 px-2 text-center"></th>
                      <th class="py-1 px-2 text-center">Cant.</th>
                      <th class="py-1 px-2 text-center">Producto</th>
                      <th class="py-1 px-2 text-center">Precio</th>
                      <th class="py-1 px-2 text-center">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-12 col-md-4 summary-column p-0">
              <div class="summary-panel bg-gradient bg-dark bg-opacity-50 border h-100 p-3 text-light">
                <div class="d-flex justify-content-between align-items-center ">
                    <h5 class="mb-0">Resumen de Venta</h5>
                        <div class="px-3 py-2 rounded text-end">
                            <input type="hidden" name="sub_total" value="0">
                            <input type="hidden" class="form-control form-control-sm rounded-0 text-end" step="any" min="0" max="100" name="descuento" value="0">
                            <input type="hidden" class="form-control form-control-sm rounded-0 text-end" step="any" min="0" max="100" name="tax" value="0">
    
                            <input type="hidden" name="tendered_amount" value="0">
                            <input type="hidden" name="payment_type_id" >
                            <input type="hidden" name="amount_change" value="0">
                            <input type="hidden" name="grand_total" value="0">
                            <input type="hidden" name="tax_amount" value="0">
                            <span class="h6 mb-0">Total: </span>
                            <span class="h4 fw-bold" id="grand_total">0.00</span>
                        </div>
                  </div>

                  <div class="row mt-3 g-2">
                    <div class="col-6">
                      <button class="btn btn-primary btn-sm rounded-0 w-100"
                              type="button"
                              id="scanQR">
                        <i class="mdi mdi-plus"></i> Pago
                      </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-success btn-sm rounded-0 w-100"
                                type="button"
                                id="check_out">
                          <i class="mdi mdi-check"></i> Finalizar
                        </button>
                      </div>
                  </div>
                  <div class="form-group mb-3">
                    <label for="payment_type_id" class="control-label">Tipo de Pago</label>
                    <select id="payment_type_id" class="form-select form-select-sm rounded-0" required>
                        <option value=""></option>
                        {% for pay in payment %}
                            {% if product.pay_id.name == pay.name %}
                            {% else %}
                            <option value="{{ pay.id }}">{{ pay.name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                  </div>
                  <div class="form-group mb-3">
                    <label for="tendered_amount" class="control-label"></label>
                    <input type="number" step="any" id="tendered_amount" class="form-control form-control-lg rounded-0 text-end" value="0" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="payment_change" class="control-label">Vuelto</label>
                    <input type="text" id="payment_change" class="form-control form-control-lg rounded-0 text-end" value="{{ 0|floatformat:2 }}" required disabled>
                  </div>
              </div>
            </div>
          </div>
        </fieldset>
      </form>
    </div>
  </div>



<noscript id="item-clone">
    <tr>
        <td class="px-2 py-1 text-center">
            <button class="btn btn-sm btn-outline-danger rounded-0 rem-item" type="button"><i class="mdi mdi-close"></i></button>
        </td>
        <td class="px-2 py-1">
            <input type="hidden" name="product_id[]">
            <input type="hidden" name="price[]">
            <input type="hidden" name="feature_id[]"> <!-- Asegúrate de incluir este campo -->

            <input type="number" name="qty[]" min="0" class="form-control form-control-sm rounded-0 text-center">
        </td>
        <td class="px-2 py-1 product_name text-start"></td>
        <td class="px-2 py-1 product_price text-end"></td>
        <td class="px-2 py-1 product_total text-end"></td>
    </tr>
</noscript> {% endblock pageContent %} {% block ScriptBlock %}

{% if mostrar_modal %}
<script>
  $(document).ready(function () {
    $('#modalCajaCerrada').modal('show');
  });
</script>
{% endif %}


<script>
    var product_json = '{{ product_json }}'
    if (product_json == "" || product_json == "{}") {
        product_json = {}
    } else {
        product_json = product_json.replaceAll('&quot;', '"')
        product_json = $.parseJSON(product_json)
    }

    var prod_arr = {}; // Almacenará los productos
    var feature_arr = {}; // Almacenará las características de los productos
    
    if (Object.keys(product_json).length > 0) {
        Object.keys(product_json).map(k => {
            var product = product_json[k];
            prod_arr[product.id] = product; // Guardar el producto
            // Procesar características del producto
            if (product.features && product.features.length > 0) {
                product.features.map(feature => {
                    feature_arr[feature.id] = feature; // Guardar cada característica por su ID
                });
            }
        });
    }
    



    $("#scanQR").click(function(){
        $("#qrModal").modal('show');
      });


      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      let beep = document.getElementById('beep');


      scanner.addListener('scan', function (content) {
        const partes = content.split('-');
      
        const idProducto = partes[0];
      
        console.log(idProducto);
        document.getElementById('qrText').innerText = idProducto;
      
        scanner.stop();
      
        beep.play();
      
        $('#product-id').val(idProducto).trigger('change'); // Selecciona y actualiza el select2 con el producto correspondiente
      
        $('#product-qty').val(1);
      
        $("#qrModal").modal('hide');
      });

      $(document).ready(function(){
        $("#scanQR").click(function(){
          Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
              scanner.start(cameras[0]);
            } else {
              console.error('No cameras found.');
            }
          }).catch(function (e) {
            console.error(e);
          });
          $("#qrModal").modal('show');
        });
        $('#qrModal').on('hidden.bs.modal', function (e) {
          document.getElementById('qrText').innerText = "";
          scanner.stop();
          
        })
      });

     //   

    
     $(document).ready(function () {
        let productData = JSON.parse('{{ product_json|escapejs }}');
        const quantityInput = $('#product-qty');
        const featureSelect = $('#feature-id');
        const featureContainer = $('#feature-select-container');
        const productSelect = $('#product-id');
        const cashRegisterSelect = $('#cash_register_select'); 
        const cashRegisterIdInput = $('#cash_register_id_input'); 


        cashRegisterSelect.change(function() {
            cashRegisterIdInput.val($(this).val()); // Set the value of the hidden input
        });

        cashRegisterIdInput.val(cashRegisterSelect.val());

        // Evento al cambiar el producto seleccionado
        productSelect.change(function () {
            let productId = $(this).val();
            let selectedProduct = productData.find(product => product.id == productId);
    
            // Limpiar características y ocultar el contenedor
            featureSelect.empty().append('<option value="" disabled selected></option>');
            featureContainer.addClass('d-none');
    
            if (selectedProduct) {
                // Manejar características si existen
                if (selectedProduct.features.length > 0) {
                    selectedProduct.features.forEach(feature => {
                        featureSelect.append(
                            `<option value="${feature.id}" data-stock="${feature.stock}">
                                ${feature.color} - ${feature.size} (STK: ${feature.stock})
                            </option>`
                        );
                    });
                    featureContainer.removeClass('d-none');
                }
    
                // Establecer el stock máximo para el producto general
                quantityInput.attr('max', selectedProduct.stock || 0);
                quantityInput.val(1); // Reiniciar cantidad
            }
        });
    
        // Evento al cambiar la característica seleccionada
        featureSelect.change(function () {
            let selectedFeature = $(this).find('option:selected');
            let featureStock = parseInt(selectedFeature.data('stock')) || 0;
    
            // Actualizar el stock máximo basado en la característica seleccionada
            quantityInput.attr('max', featureStock);
            quantityInput.val(1); // Reiniciar cantidad
        });
    
        // Validar cantidad ingresada
        quantityInput.on('input', function () {
            let maxStock = parseInt($(this).attr('max')) || 0;
            let currentQty = parseInt($(this).val()) || 0;
    
            if (currentQty > maxStock) {
                $(this).val(maxStock);
                alert('No puedes agregar más cantidad que el stock disponible.');
            }
        });
    });
    
    

    function calc() {
        var sub_total = 0;
        var grand_total = 0;
      
        $('#POS-field table tbody tr').each(function() {
          price = $(this).find('[name="price[]"]').val();
          qty = $(this).find('[name="qty[]"]').val();
          qty = qty > 0 ? qty : 0;
          total = parseFloat(price) * parseFloat(qty);
          $(this).find('.product_total').text(parseFloat(total).toLocaleString('en-US'));
          sub_total += parseFloat(total);
        });
      
        // Get discount value (assuming it's from an input field)
        descuento = $('[name="descuento"]').val(); // Get and handle potential empty value
      
        // Calculate discount amount as a percentage of subtotal
      
        tax = $('[name="tax"]').val();
        tax = tax/100 ;
        

        var tax_amount = (parseFloat(sub_total)-descuento) * parseFloat(tax);

      

        $('#sub_total').text(parseFloat(sub_total).toLocaleString('en-US'));
        $('[name="sub_total"]').val(parseFloat(sub_total));

        $('#descuento').text(parseFloat(descuento).toLocaleString('en-US')); // Add display for discount amount (optional)
        $('[name="descuento"]').val(parseFloat(descuento)); // Add input for discount amount (optional)
      
        $('#tax_amount').text(parseFloat(tax_amount).toLocaleString('en-US'));
        $('[name="tax_amount"]').val(parseFloat(tax_amount));
        //grand_total = sub_total - descuento;
        // Update grand total including tax and minus discount

        grand_total = sub_total + tax_amount - descuento;
        $('#grand_total').text(parseFloat(grand_total).toLocaleString('en-US'));
        $('[name="grand_total"]').val(parseFloat(grand_total).toLocaleString('en-US'));
        
      }
    
    $(function() {
        $('#product-id').select2({
            placeholder: "Selecciona los productos",
            width: '100%'
        })

        $('#add_item').click(function() {
            var id = $('#product-id').val()
            var qty = $('#product-qty').val()
            var feature_id = $('#feature-id').val(); // Obtener el ID de la característica seleccionada

            let productData = JSON.parse('{{ product_json|escapejs }}');
            const productId = id;
            const featureId = feature_id;
            const selectedProduct = productData.find(product => product.id == productId);
            

    
            // Validar que se seleccione una característica si el producto tiene características
            if (selectedProduct && selectedProduct.features.length > 0 && !featureId) {
                alert("Debe seleccionar una característica del producto antes de agregarlo");
                return false;
            }
    
    
            if (id == '' || qty == '' || id == null || qty == null) {
                alert("El campo Producto y Cantidad es obligatorio")
                return false
            }

            if (feature_id == '') {
                alert("Debe seleccionar una característica del producto antes de agregarlo");
                return false;
            }
            console.log(feature_id)

            // Si el producto tiene características, se puede agregar varias veces con diferentes combinaciones
            if (!!prod_arr[id]) {
                // Si el producto tiene características, verificar si se ha agregado con la misma combinación de características
                if (feature_id) {
                    if ($('#POS-field table tbody input[name="feature_id[]"][value="' + feature_id + '"]').length > 0) {
                        alert('El producto con las caracteristicas seleccionadas ya está en la lista');
                        return false;
                    }
                } else {
                    // Si el producto no tiene características, verificar si el producto ya está en la lista
                    if ($('#POS-field table tbody input[name="product_id[]"][value="' + id + '"]').length > 0 &&
                        $('#POS-field table tbody input[name="feature_id[]"][value=""]').length > 0) {
                        alert('El producto ya está en la lista');
                        return false;
                    }
                }


                data = prod_arr[id]
                feature = feature_arr[feature_id] || {}; // Datos de la característica (asegúrate de tener feature_arr con información)
                var tr = $($('noscript#item-clone').html()).clone()
                var maxQty = feature_id && feature.stock ? feature.stock : data.stock;

                tr.find('[name="qty[]"]').val(qty)
                tr.find('[name="product_id[]"]').val(id)
                tr.find('[name="price[]"]').val(data.price)
                tr.find('[name="feature_id[]"]').val(feature_id); // Añadir feature_id a la fila

                var productName = data.name;
                if (feature_id && feature.size) productName += " - Tamaño: " + feature.size;
                if (feature_id && feature.color) productName += " - Color: " + feature.color;
        
                tr.find('.product_name').text(productName)
                tr.find('.product_price').text(parseFloat(data.price).toLocaleString('en-US'))
                tr.find('.product_total').text(parseFloat(data.price * qty).toLocaleString('en-US'))
                $('#POS-field table tbody').append(tr)
                $('#product-id').val('').trigger('change')
                $('#product-qty').val(1)
                calc()
                tr.find('[name="qty[]"]').on('input keypress keyup keydown', function() {
                    var currentQty = $(this).val();
                    if (currentQty > maxQty) {
                        $(this).val(maxQty); // Limitar la cantidad a la disponible
                        alert(`No puedes agregar más de ${maxQty} unidades del producto.`);
                    }
                    calc()
                })
                tr.find('.rem-item').click(function() {
                    if (confirm("¿Está seguro de eliminar " + data.name + " de la lista de productos?") == true) {
                        tr.remove()
                        calc()
                    }
                })
            } else {
                alert("Producto no definido");
            }
        })
        $('[name="tax"], [name="descuento"]').on('input keypress keydown keyup', function() {
        calc();
        })
        /*
        $('#check_out').click(function() {
            if ($('#POS-field table tbody tr').length <= 0) {
                alert("Agregue al menos 1 producto primero")
                return false;
            }
        
            var payment_type_id = $('#payment_type_id').val()
            $('[name="payment_type_id"]').val(payment_type_id)

            var payment_type_id = $('#amoint').val()
            if ($('[name="amount_change"]').val() < 0) {
                alert("El monto ofrecido es menor que el monto a pagar")
                return false;
            }
            //uni_modal("Registrar", "{% url 'checkout-modal' %}?grand_total=" + $('[name="grand_total"]').val())

        })*/

        $('#check_out').on('click', function () {
            const paymentType = $('#payment_type_id').val();
            const tendered = parseFloat($('#tendered_amount').val()) || 0;
            const total = parseFloat($('#grand_total').text()) || 0;
            const change = tendered - total;


            if ($('#POS-field table tbody tr').length <= 0) {
                alert("Agregue al menos 1 producto primero")
                return false;
            }
    
            var payment_type_id = $('#payment_type_id').val()
            $('[name="payment_type_id"]').val(payment_type_id)

            if ($('[name="amount_change"]').val() < 0) {
                alert("El monto ofrecido es menor que el monto a pagar")
                return false;
            }
            if (!paymentType) {
              alert("Por favor selecciona un tipo de pago");
              return;
            }
      
            if (change < 0) {
              alert("El monto entregado es menor al total a pagar");
              return;
            }
      
            // Mostrar valores en el modal
            $('#modal_grand_total').text(total.toFixed(2));
            $('#modal_tendered_amount').text(tendered.toFixed(2));
            $('#modal_amount_change').text(change.toFixed(2));
      
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
            modal.show();
          });
      
          $('#confirm_submit').on('click', function () {
            // Opcional: usar el estado del switch
            const printTicket = $('#print_ticket').is(':checked');
      
            // Puedes enviar esta info como un input hidden si deseas
            if (printTicket) {
              $('<input>').attr({
                type: 'hidden',
                name: 'print_ticket',
                value: '1'
              }).appendTo('#pos-form');
            }
      
            // Ahora sí: enviar formulario
            $('#pos-form').submit();
          });



        // Calcular Vuelto
        $(document).ready(function () {
            function calcularVuelto() {
              const tendered = parseFloat($('#tendered_amount').val()) || 0;
              const total = parseFloat($('#grand_total').text()) || 0;
              const change = tendered - total;
        
              $('[name="tendered_amount"]').val(tendered.toFixed(2));
              $('[name="amount_change"]').val(change.toFixed(2));
              $('#payment_change').val(change.toFixed(2));
            }
        
            $('#tendered_amount').on('input', calcularVuelto);

        });


        $('#pos-form').submit(function(e) {
            e.preventDefault();

            const tendered = parseFloat($('#tendered_amount').val()) || 0;
            const total = parseFloat($('#grand_total').text()) || 0;
            const change = tendered - total;
            if (change < 0) {
                alert("El monto entregado es menor al total a pagar");
                return false;
              }

            var _this = $(this)
            $('.err-msg').remove();
            var el = $('<div>')
            el.addClass("alert alert-danger err-msg")
            el.hide()
            if (_this[0].checkValidity() == false) {
                _this[0].reportValidity();
                return false;
            }
            start_loader();
            $.ajax({
                headers: {
                    "X-CSRFToken": '{{csrf_token}}'
                },
                url: "{% url 'save-pos' %}",
                data: new FormData($(this)[0]),
                cache: false,
                contentType: false,
                processData: false,
                method: 'POST',
                type: 'POST',
                dataType: 'json',
                error: err => {
                    console.log(err)
                    end_loader();
                },
                success: function(resp) {
                    if (typeof resp == 'object' && resp.status == 'success') {
                        el.removeClass("alert alert-danger err-msg")
                            // location.reload()
                        uni_modal("Recibo", "{% url 'receipt-modal' %}?id=" + resp.sale_id)
                        $('#uni_modal').on('hide.bs.modal', function() {
                            location.reload()
                        })
                    } else if (resp.status == 'failed' && !!resp.msg) {
                        el.text(resp.msg)
                    } else {
                        el.text("Ocurrio un error", 'error');
                        end_loader();
                        console.err(resp)
                    }
                    _this.prepend(el)
                    el.show('slow')
                    $("html, body, .modal").scrollTop(0);
                    end_loader()
                }
            })
        })
    })
</script>
{% endblock ScriptBlock %}