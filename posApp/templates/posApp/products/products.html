{% extends "posApp/base.html" %} {% block pageContent %}
<audio id="beep" src="https://bigsoundbank.com/UPLOAD/wav/1417.wav" preload="auto"></audio>


<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Lista de productos</h4>
            <div class="text-start">
                {% if request.user.is_superuser %}
                    <button class="btn btn-primary bg-gradient btn-sm rounded-0" id="create_new"><i class="mdi mdi-plus"></i><span> Agregar nuevo</span></button>
                {% endif %}
                <!-- 
                  <button class="btn btn-primary bg-gradient btn-sm rounded-0" id="scanQR"><i class="mdi mdi-plus"></i><span> Escanear producto</span></button>
                -->

            </div>

        </div>
    </div>
</div>



<!-- Modal QR-->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrModalLabel">Código QR del Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex justify-content-center">
          <img id="qrImage" src="" alt="Código QR" style="max-width: 100%;">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

<!--Contenido QR-->
<div class="modal fade" id="qrModal2" tabindex="-1" aria-labelledby="qrModal2Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qrModal2Label">Escanear producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex flex-column align-items-center">
          <video id="preview" style="width: 100%;"></video>
          <p id="qrText" class="increased-font-size"> </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

<!-- Modal Foto -->
<div class="modal fade" id="fotoModal" tabindex="-1" aria-labelledby="fotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="fotoModalLabel">Foto del producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body d-flex justify-content-center">
          <img id="a"  alt="" style="max-width: 100%;">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>




<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
  <div class="mdc-card">
    <form method="get" action="{% url 'product-page' %}">
      <div class="row mb-3">
        <!-- Buscar Producto -->
        <div class="col-md-6 col-lg-2 mb-2">
          <div class="input-group">
            <input type="text" name="search" class="form-control" placeholder="Buscar producto por nombre" value="{{ request.GET.search }}">
          </div>
        </div>
    
        <!-- Filtrar por Categoría -->
        <div class="col-md-6 col-lg-2 mb-2">
          <div class="input-group">
            <select name="category" class="form-select">
              <option value="">Todas las categorías</option>
              {% for category_id in categories %}
                <option value="{{ category_id.id }}" {% if category_filter|add:""|stringformat:"s" == category_id.id|stringformat:"s" %}selected{% endif %}>
                  {{ category_id.name }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
    
        <!-- Filtrar por Estado -->
        <div class="col-md-6 col-lg-2 mb-2">
          <div class="input-group">
            <select name="status" class="form-select">
              <option value="">Todos los estados</option>
              <option value="1" {% if request.GET.status == "1" %}selected{% endif %}>Activo</option>
              <option value="0" {% if request.GET.status == "0" %}selected{% endif %}>Inactivo</option>
            </select>
          </div>
        </div>
    
        <!-- Botones -->
        <div class="col-12 col-lg-2 mb-2">
          <div class="row">
            <div class="col-6">
              <button type="submit" class="btn btn-primary w-100">Buscar</button>
            </div>
            <div class="col-6">
              <a href="{% url 'product-page' %}" class="btn btn-secondary w-100">Limpiar</a>
            </div>
          </div>
        </div>
      </div>
    </form>
    
      <div class="table-responsive">
          <table class="table table-striped table-bordered">
              <colgroup>
                  <col width="5%">
                  <col width="20%">
                  <col width="20%">
                  <col width="25%">
                  <col width="15%">
                  <col width="5%">
              </colgroup>
              <thead>
                  <tr>
                      <th class="text-center py-1">#</th>
                      <th class="text-center py-1">Categoria</th>
                      <th class="text-center py-1">Producto</th>
                      <th class="text-center py-1">Precio Unit.</th>
                      <th class="text-center py-1">Stock</th>
                      <th class="text-center py-1">Status</th>
                      {% if request.user.is_superuser %}
                      <th class="text-center py-1">Accion</th>
                      {% endif %}
                  </tr>
              </thead>
              <tbody>
                  {% for product in products %}
                  <tr>
                      <td class="px-2 py-1 text-center">{{ product.id }}</td>
                      <td class="px-2 py-1 text-start">{{ product.category_id }}</td>
                      <td class="px-2 py-1 text-start">{{ product.name }}</td>
                      <td class="px-2 py-1 text-start">S/ {{ product.price }}</td>
                      <td class="px-2 py-1 text-start">
                        {% if product.category_id.name|lower == 'parque' %}
                              -
                          {% else %}
                              {{ product.stock }}
                          {% endif %}
                      </td>
                      <td class="px-2 py-1 text-center">
                        {% if product.status == 1 %}
                        <span class="badge bg-primary rounded-pill px-3">Activo</span> {% else %}
                        <span class="badge bg-secondary rounded-pill px-3">Inactivo</span> {% endif %}
                      </td>  

                      {% if request.user.is_superuser %}

                      <td class="px-2 py-1 text-center">
                        <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--light mdc-ripple-upgraded edit-data" type="button" data-id="{{ product.pk }}" title="Editar">
                          <i class="material-icons mdc-button__icon">edit</i>
                        </button>
                        <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--danger mdc-ripple-upgraded delete-data" type="button" data-id="{{ product.pk }}" title="Borrar">
                            <i class="material-icons mdc-button__icon">delete</i>
                        </button>

                      <!-- 
                        <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--blue mdc-ripple-upgraded foto" type="button" data-id="{{ product.image }}" title="Imagen">
                          <i class="fa-solid fa-image"></i>
                        </button>
                        <button class="mdc-button mdc-button--raised p-1 icon-button filled-button--dark mdc-ripple-upgraded generate-qr" type="button" data-id="{{ product.pk }}" title=" QR">
                            <i class="fa-solid fa-qrcode"></i>
                        </button>
                      -->
                      </td>
                      {% endif %}
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>

      <div class="row align-items-center mt-3">
          <div class="col-md-6">
              <p class="mb-0">
                  Mostrando {{ products.start_index }} - {{ products.end_index }} de {{ total_products }} productos
              </p>
          </div>
          <div class="col-md-6">
              <div class="d-flex justify-content-end align-items-center gap-2">
                  <form method="get" class="d-flex align-items-center me-2">
                      <!-- Mantener filtros -->
                      <input type="hidden" name="search" value="{{ request.GET.search }}">
                      <input type="hidden" name="category" value="{{ request.GET.category }}">
                      <input type="hidden" name="status" value="{{ request.GET.status }}">
      
                      <label for="per_page" class="me-1 mb-0">Mostrar</label>
                      <select name="per_page" id="per_page" class="form-select form-select-sm" onchange="this.form.submit()">
                          <option value="5" {% if request.GET.per_page == '5' %}selected{% endif %}>5</option>
                          <option value="10" {% if request.GET.per_page == '10' or not request.GET.per_page %}selected{% endif %}>10</option>
                          <option value="20" {% if request.GET.per_page == '20' %}selected{% endif %}>20</option>
                          <option value="50" {% if request.GET.per_page == '50' %}selected{% endif %}>50</option>
                      </select>
                  </form>
      
                  <nav aria-label="Paginación">
                      <ul class="pagination pagination-sm mb-0">
                          {% if products.has_previous %}
                              <li class="page-item">
                                  <a class="page-link" href="?{{ base_url }}&page={{ products.previous_page_number }}">Anterior</a>
                              </li>
                          {% else %}
                              <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                          {% endif %}
      
                          {% for num in products.paginator.page_range %}
                              {% if products.number == num %}
                                  <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                              {% elif num > products.number|add:-3 and num < products.number|add:3 %}
                                  <li class="page-item"><a class="page-link" href="?{{ base_url }}&page={{ num }}">{{ num }}</a></li>
                              {% endif %}
                          {% endfor %}
      
                          {% if products.has_next %}
                              <li class="page-item">
                                  <a class="page-link" href="?{{ base_url }}&page={{ products.next_page_number }}">Siguiente</a>
                              </li>
                          {% else %}
                              <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                          {% endif %}
                      </ul>
                  </nav>
              </div>
          </div>
      </div>
      
    
  </div>
</div>


{% endblock pageContent %} {% block ScriptBlock %}
<script>
    
    function myFunction() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("myTable");
        tr = table.getElementsByTagName("tr");
        for (i = 0; i < tr.length; i++) {
          td = tr[i].getElementsByTagName("td")[1]; // Cambia el índice según la columna en la que quieras buscar
          if (td) {
            txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }       
        }
      }
//
function submitForm(product_pk) {
  document.getElementById("upload-file" + product_pk).submit();
}

//
      $("#scanQR").click(function(){
        $("#qrModal2").modal('show');

      });

      let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
      let beep = document.getElementById('beep');

      scanner.addListener('scan', function (content) {
        const partes = content.split('-');
      
        const idProducto = partes[1];
      
        console.log(idProducto);
        document.getElementById('qrText').innerText = content;
        document.getElementById('preview').style.width = '0%';
        document.getElementById('preview').style.opacity = 1; // Reset video opacity
        scanner.stop();
      
        beep.play();

        $('#product-id').val(idProducto);
      
        $('#product-qty').val(1);
    
      });

      $(document).ready(function(){
        
        $("#scanQR").click(function(){
          Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
              scanner.start(cameras[0]);
            } else {
              console.error('No cameras found.');
            }
          }).catch(function (e) {
            console.error(e);
          });
          $("#qrModal2").modal('show');
        });
        $('#qrModal2').on('hidden.bs.modal', function (e) {
          document.getElementById('qrText').innerText = "";
          document.getElementById('preview').style.width = '100%';
          scanner.stop();
          
        })
      });

    $(function() {
        $('#create_new').click(function() {
            uni_modal("Agregar nuevos productos", "{% url 'manage_products-page' %}")
        })
        $('.edit-data').click(function() {
            uni_modal("Editar producto", "{% url 'manage_products-page' %}?id=" + $(this).attr('data-id'))
        })
        $('.delete-data').click(function() {
            _conf("¿Estás seguro de eliminar este producto?", "delete_product", [$(this).attr('data-id')])
        })

        $('#uni_modal').on('shown.bs.modal', function() {
            $('#category_id').select2({
                placeholder: "Selecciona la categoria",
                width: '100%',
                dropdownParent: $('#uni_modal')
            })
        })
    })


    function delete_product($id) {
      start_loader();
      $.ajax({
          headers: {
              "X-CSRFToken": '{{csrf_token}}'
          },
          url: "{% url 'delete-product' %}",
          method: "POST",
          data: {
              id: $id
          },
          dataType: "json",
          error: err => {
              console.log(err);
              alert("Ocurrió un error al intentar eliminar el producto.");
              end_loader();
          },
          success: function(resp) {
              if (typeof resp == 'object' && resp.status == 'success') {
                  location.reload();
              } else if (resp.status == 'failed' && resp.message) {
                  alert(resp.message); // Mostrar el mensaje personalizado del backend
              } else {
                  alert("Ocurrió un error inesperado.");
              }
              end_loader();
          }
      });
  }
//
$('.generate-qr').click(function() {
    var product_id = $(this).attr('data-id');
    generate_qr(product_id);
    
})

function generate_qr(product_id) {
    $.ajax({
        headers: {
            "X-CSRFToken": '{{csrf_token}}'
        },
        url: "{% url 'generate-qr' %}",
        method: "POST",
        data: {
            id: product_id
        },
        dataType: "json",
        error: err => {
            console.log(err)
            alert_toast("Ocurrio un error", 'error');
        },
        success: function(resp) {
            if (typeof resp == 'object' && resp.status == 'success') {
                $('#qrModal img').attr('src', resp.qr_url);
                $('#qrModal').modal('show');
            } else {
                alert_toast("Ocurrio un error", 'error');
            }
        }
    })
}


$('.foto').click(function() {
  var productId = $(this).attr('data-id');
  productId = productId.replace(/%/g, ' ');
  $('#a').attr('src', productId);
  $('#fotoModal').modal('show');
});



</script>
{% endblock ScriptBlock %}